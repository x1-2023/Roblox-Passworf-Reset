(()=>{"use strict";const e={API_KEY:{key:"api_key",defaultValue:""},APP_ID:{key:"appId",defaultValue:""},POWER_ON:{key:"power_on",defaultValue:!0},TIKTOK:{key:"tiktok",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},FUNCAPTCHA:{key:"funcaptcha",defaultValue:{delayClick:100,loop:!0,isActive:!0,maxImageCaptcha:25}},ZALO:{key:"zalo",defaultValue:{delayClick:100,loop:!0,isActive:!0}},SHOPEE:{key:"shopee",defaultValue:{delaySwipe:15,loop:!0,isActive:!0}},RECAPTCHAV2:{key:"reCaptchav2",defaultValue:{delayClick:500,loop:!0,isActive:!0,useToken:!1}},AMZN:{key:"amzn",defaultValue:{delayClick:100,loop:!0,isActive:!0}},GEETEST:{key:"geetest",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},SLIDE_ALL:{key:"slide_all",defaultValue:{delaySwipe:15,loop:!0,isActive:!0}},HCAPTCHA:{key:"hcaptcha",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},CLOUDFLARE:{key:"cloudflare",defaultValue:{delayClick:2e3,isActive:!0}}};async function t(e,t,o){const a="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{return await new Promise(((n,r)=>{a.sendMessage({source:e,type:t,data:o},(e=>{a.lastError?r(new Error(`Error sending message: ${a.lastError.message}`)):n(e)}))}))}catch(e){throw console.error(`[messageHelpers] Error in sending message: ${e.message}`),e}}const o=async(e,t)=>{const o="undefined"!=typeof browser?browser.storage.local:chrome.storage.local,a="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{const n=await o.get([e]);if(a.lastError)throw new Error(`Error retrieving ${e}: ${a.lastError.message}`);return null!=n[e]?n[e]:t}catch(t){throw console.error(`[storageHelpers] Error retrieving ${e}:`,t),t}};Promise.resolve();async function a(e){return new Promise((t=>setTimeout(t,e)))}let n,r,i,c,s;console.log("Run shopee...",window.location.href);let l=!1,d=[];async function u(){console.log("[shopee] Da den captchaSlide()");for(var e="",t=0;t<30;t++){await a(1e3);var o=document.querySelector('[role="dialog"] [id*="captchaMask"] div > div:nth-of-type(1) > img');if(o&&e!==o.src){e=o.src;var n=document.querySelector('[role="dialog"] [id*="captchaMask"] div > div:nth-of-type(2) > img');const t=await m(e,n.src);if(""===t){if(c){await g(n,1);continue}}else{const o=await v(t,30);if("Server 500"===o){e="";continue}if(""===o&&c){await g(n,1);continue}let a=parseInt(o.end.x,10);if(await g(n,a),!c)return}}}}async function h(){console.log("[shopee] ƒê√£ v√†o captchaSlide_new");for(var e="",t=0;t<30;t++){await a(600+800*Math.random());const t=document.querySelector('[id*="NEW_CAPTCHA"] [id*="captchaMask"] div > div:nth-of-type(1) > img'),o=document.querySelector('[id*="sliderContainer"]'),n=document.querySelector('[id*="NEW_CAPTCHA"] [id*="captchaMask"] div > div:nth-of-type(2) > img');if(t&&o&&n){if(e!==t.src){e=t.src;const r=await m(e,n.src,"rotate");if(!r){if(console.warn("[shopee] Kh√¥ng l·∫•y ƒë∆∞·ª£c taskId t·ª´ API"),c)continue;return}d.push(r);const i=await v(r,30);if(!i||"Server 500"===i){console.warn("[shopee] L·ªói server ho·∫∑c r·ªóng, th·ª≠ l·∫°i"),e="";continue}if(!i.point||!i.point.x||!i.point.y){if(console.error("[shopee] API tr·∫£ v·ªÅ point kh√¥ng h·ª£p l·ªá:",i),c)continue;return}let s=parseFloat(i.point.x),l=parseFloat(i.point.y);const u=t.getBoundingClientRect(),h=u.width/t.naturalWidth,p=u.height/t.naturalHeight,f=u.left+s*h,g=u.top+l*p;if(console.log(`[shopee] API point=(${s},${l}), scale=(${h},${p}), targetScreen=(${f},${g})`),await y(o,n,f,g),await a(3e3),location.href.includes("/verify/captcha?anti_bot_tracking_id")&&(console.log("[shopee] V·∫´n c√≤n captcha, g·ª≠i report"),await w(!1)),!c)return}}else console.warn("[shopee] Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ c·∫ßn thi·∫øt")}}function p(e){return!!document.querySelector(e)}async function f(e,t){const o=Date.now()+t;for(;Date.now()<o;){for(const t of e){if(document.querySelector(t))return!0}await a(500)}return!1}function g(e,t){return new Promise(((o,a)=>{if(!e)return console.error("Element not found"),void a("Element not found");function n(){const t=e.getBoundingClientRect();return{centerX:t.left+t.width/2,centerY:t.top+t.height/2}}const r=new DataTransfer;function i(t,o,a){const n={bubbles:!0,cancelable:!0,clientX:o,clientY:a,dataTransfer:r,...arguments.length>3&&void 0!==arguments[3]?arguments[3]:{}},i=t.includes("drag")?new DragEvent(t,n):new MouseEvent(t,n);e.dispatchEvent(i)}const c=n(),s=c.centerX+t;i("pointerenter",c.centerX,c.centerY),i("mouseover",c.centerX,c.centerY),i("mousedown",c.centerX,c.centerY),i("dragstart",c.centerX,c.centerY);let l=c.centerX,d=10,u=3;!function e(){const a=n();if(Math.abs(a.centerX-s)<=1)return void setTimeout((()=>{i("dragend",a.centerX,a.centerY),i("mouseup",a.centerX,a.centerY),o()}),1e3);s-a.centerX>t/4?(d=10,u=3):(d=1,u=10),l+=d*Math.sign(s-a.centerX);const r=a.centerY;i("mousemove",l,r),i("drag",l,r),setTimeout(e,u)}()}))}async function y(e,t,o,a){if(!e||!t)return void console.error("[shopee] ‚ùå Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ ƒë·ªÉ k√©o");function n(e){const t=e.getBoundingClientRect();return{x:t.left+t.width/2,y:t.top+t.height/2}}const r=e=>new Promise((t=>setTimeout(t,e))),i=new DataTransfer;function c(t,o,a){const n=t.includes("drag")?new DragEvent(t,{bubbles:!0,cancelable:!0,clientX:o,clientY:a,dataTransfer:i}):new MouseEvent(t,{bubbles:!0,cancelable:!0,clientX:o,clientY:a});e.dispatchEvent(n)}const s=n(e);c("pointerenter",s.x,s.y),c("mouseover",s.x,s.y),await r(50+150*Math.random()),c("mousedown",s.x,s.y),c("dragstart",s.x,s.y);let l=s.x,d=s.y,u=1,h=0;for(console.log(`[shopee] üü¢ K√©o t·ª´ (${s.x}, ${s.y}) ƒë·∫øn (${o}, ${a})`);;){const e=n(t),i=o-e.x,s=a-e.y,p=Math.sqrt(i*i+s*s);if(1===u&&p<5){console.log("[shopee] üü† Phase 1: Overshoot +50px");const e=50;l+=i/p*e,d+=s/p*e,c("mousemove",l,d),c("drag",l,d),u=2,await r(100+50*Math.random());continue}if(2===u){console.log("[shopee] üîµ Phase 2: Rollback -50px");const e=-50;l+=i/p*e,d+=s/p*e,c("mousemove",l,d),c("drag",l,d),u=3,await r(120+50*Math.random());continue}if(3===u&&p<3){console.log(`[shopee] ‚úÖ Snap cu·ªëi: c√°ch ${p.toFixed(2)}px`),l+=i,d+=s,c("mousemove",l,d),c("drag",l,d);break}let f;f=p>50?6+1.5*Math.random():p>20?3+1*Math.random():1.5+.5*Math.random();const g=.5+Math.random(),y=Math.sin(h/300*Math.PI)*g*5;if(l+=i/p*f+.5*(Math.random()-.5),d+=s/p*f+y+.5*(Math.random()-.5),c("mousemove",l,d),c("drag",l,d),h%10==0&&Math.random()<.01){c("mousemove",l+4*(Math.random()-.5),d+4*(Math.random()-.5)),await r(10+30*Math.random())}let m;if(h===Math.floor(150)&&Math.random()<.8&&(console.log("[shopee] ‚ö™ Gi·∫£ v·ªù pause gi·ªØa ch·ª´ng"),await r(150+150*Math.random())),m=p>50?10+10*Math.random():p>20?20+20*Math.random():30+20*Math.random(),await r(m),h++,h>300){console.warn("[shopee] ‚ö†Ô∏è Max step, d·ª´ng ƒë·ªÉ tr√°nh v√≤ng l·∫∑p v√¥ t·∫≠n");break}}await r(80+50*Math.random()),c("dragend",l,d),c("mouseup",l,d),console.log("[shopee] üü¢ ƒê√£ nh·∫£ chu·ªôt xong")}async function m(e,o){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";const n=JSON.stringify({clientKey:r,task:{type:"ShopeeSliderWebTask",typeCaptcha:a,imageBase64s:[e,o]}});try{const e=await t("SHOPEE","createTask",n);return e||(console.error("[shopee] No taskId returned from createTask"),"")}catch(e){return console.error("[shopee] Failed to create task:",e),""}}async function v(e,o){const a=JSON.stringify({clientKey:r,taskId:e});try{const e=await t("SHOPEE","getTaskResult",{data:a,timeWait:o});return e?"fail"===e.status?(console.error("[shopee] API error:",e),null):e.solution?e.solution:(console.error("[shopee] Invalid API response: missing solution"),""):(console.error("[shopee] No result returned from getTaskResult"),"")}catch(e){return console.error("[shopee] Failed to get task result:",e),""}}async function w(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(console.log("ƒêang check resolvedTaskIds",d),0===d.length)return;const o={taskIds:d,result:e};try{await t("SHOPEE","reportTask",o)}catch(e){console.error("Failed to send report:",e)}finally{d=[]}}new MutationObserver((async(e,t)=>{await async function(e){if(n&&s&&r&&"YOUR_CLIEN_KEY"!==r){console.log("[shopee] handleElementMutation");for(const t of e)if("childList"===t.type){const e=document.querySelector('[role="dialog"] [id*="captchaMask"]'),t=document.querySelector('[id*="NEW_CAPTCHA"] [id*="captchaMask"]');if(e||t){if(console.log("[shopee] Tim thay targetElement"),!l){if(!r)return;l=!0,await a(1e3),f(['[role="dialog"] [id*="captchaMask"] div > div:nth-of-type(1) > img','[role="dialog"] [id*="captchaMask"] div > div:nth-of-type(2) > img','[id*="NEW_CAPTCHA"] [id*="captchaMask"] div > div:nth-of-type(1) > img','[id*="NEW_CAPTCHA"] [id*="captchaMask"] div > div:nth-of-type(2) > img'],1e4).then((async e=>{if(e)for(var t=0;t<20;t++){if(p('[role="dialog"] [id*="captchaMask"] div > div:nth-of-type(1) > img')&&p('[role="dialog"] [id*="captchaMask"] div > div:nth-of-type(2) > img')){await u();break}if(p('[id*="NEW_CAPTCHA"] [id*="captchaMask"] div > div:nth-of-type(1) > img')&&p('[id*="NEW_CAPTCHA"] [id*="captchaMask"] div > div:nth-of-type(2) > img')){await h();break}await a(500)}}))}}else console.log("[shopee] Khong tim thay targetElement"),l=!1}}}(e)})).observe(document.body,{childList:!0,subtree:!0}),(async()=>{await async function(){n=await o(e.POWER_ON.key,e.POWER_ON.defaultValue),r=await o(e.API_KEY.key,e.API_KEY.defaultValue);const t=await o(e.SHOPEE.key,e.SHOPEE.defaultValue);i=t.delaySwipe,c=t.loop,s=t.isActive}()})()})();