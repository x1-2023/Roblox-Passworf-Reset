(()=>{"use strict";const e={register_language:async()=>{const e="undefined"!=typeof browser?browser.declarativeNetRequest:chrome.declarativeNetRequest,r="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{await new Promise(((t,a)=>{e.updateDynamicRules({removeRuleIds:[1,2,3],addRules:[{id:1,priority:1,action:{type:"redirect",redirect:{transform:{queryTransform:{addOrReplaceParams:[{key:"lang",value:"vi"}]}}}},condition:{regexFilter:"^https://zcaptcha\\.api\\.zaloapp\\.com/",resourceTypes:["main_frame","sub_frame","xmlhttprequest"]}},{id:2,priority:1,action:{type:"redirect",redirect:{transform:{queryTransform:{addOrReplaceParams:[{key:"hl",value:"en-US"}]}}}},condition:{regexFilter:"^(http|https)://[^\\.]*\\.(google\\.com|recaptcha\\.net)/recaptcha",resourceTypes:["sub_frame"]}},{id:3,priority:1,action:{type:"modifyHeaders",requestHeaders:[{header:"Accept-Language",operation:"set",value:"en-US,en;q=0.9"}]},condition:{urlFilter:"*",resourceTypes:["main_frame","sub_frame","xmlhttprequest","script","stylesheet","image","object","ping","csp_report","media","font","websocket","webtransport","webbundle","other"]}}]},(()=>{r.lastError?(console.error(`[bapi] Error updating dynamic rules: ${r.lastError.message}`),a(new Error(`Error updating dynamic rules: ${r.lastError.message}`))):(console.debug("[bapi] Successfully updated dynamic rules"),t())}))}))}catch(e){throw console.error("[bapi] Error in register_language:",e),e}}},r=e,t={API_KEY:{key:"api_key",defaultValue:""},APP_ID:{key:"appId",defaultValue:""},POWER_ON:{key:"power_on",defaultValue:!0},TIKTOK:{key:"tiktok",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},FUNCAPTCHA:{key:"funcaptcha",defaultValue:{delayClick:100,loop:!0,isActive:!0,maxImageCaptcha:25}},ZALO:{key:"zalo",defaultValue:{delayClick:100,loop:!0,isActive:!0}},SHOPEE:{key:"shopee",defaultValue:{delaySwipe:15,loop:!0,isActive:!0}},RECAPTCHAV2:{key:"reCaptchav2",defaultValue:{delayClick:500,loop:!0,isActive:!0,useToken:!1}},AMZN:{key:"amzn",defaultValue:{delayClick:100,loop:!0,isActive:!0}},GEETEST:{key:"geetest",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},SLIDE_ALL:{key:"slide_all",defaultValue:{delaySwipe:15,loop:!0,isActive:!0}},HCAPTCHA:{key:"hcaptcha",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},CLOUDFLARE:{key:"cloudflare",defaultValue:{delayClick:2e3,isActive:!0}}};let a=Promise.resolve();const o=async(e,r)=>{const t="undefined"!=typeof browser?browser.storage.local:chrome.storage.local,o="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{return a=a.then((()=>new Promise(((a,s)=>{t.set({[e]:r},(()=>{o.lastError?s(new Error(`Error setting ${e}: ${o.lastError.message}`)):(console.debug(`[storageHelpers] Setting ${e}:`,r),a(!0))}))})))),await a,!0}catch(r){throw console.error(`[storageHelpers] Error setting ${e}:`,r),r}};async function s(e){return new Promise((r=>setTimeout(r,e)))}const n={GET_BALANCE_URL:"https://api.omocaptcha.com/v2/getBalance",CREATE_JOB_URL:"https://api.omocaptcha.com/v2/createTask",GET_RESULT_URL:"https://api.omocaptcha.com/v2/getTaskResult",REPORT_URL:"https://api.omocaptcha.com/v2/report"};r.register_language();const c=async()=>{const e="undefined"!=typeof browser?browser.runtime:chrome.runtime,r="undefined"!=typeof browser?browser.storage.local:chrome.storage.local;try{if((await r.get("initialized")).initialized)console.debug("[background] Extension already initialized");else{console.debug("[background] First time running extension");const r=await fetch(e.getURL("configs.json"));if(!r.ok)throw new Error(`Failed to fetch configs.json: ${r.status}`);const a=await r.json();console.debug("[background] Config data loaded:",a);const n={[t.API_KEY.key]:t.API_KEY.defaultValue,[t.APP_ID.key]:t.APP_ID.defaultValue,[t.POWER_ON.key]:t.POWER_ON.defaultValue,[t.TIKTOK.key]:t.TIKTOK.defaultValue,[t.FUNCAPTCHA.key]:t.FUNCAPTCHA.defaultValue,[t.ZALO.key]:t.ZALO.defaultValue,[t.SHOPEE.key]:t.SHOPEE.defaultValue,[t.RECAPTCHAV2.key]:t.RECAPTCHAV2.defaultValue,[t.AMZN.key]:t.AMZN.defaultValue,[t.GEETEST.key]:t.GEETEST.defaultValue,[t.SLIDE_ALL.key]:t.SLIDE_ALL.defaultValue,[t.HCAPTCHA.key]:t.HCAPTCHA.defaultValue,[t.CLOUDFLARE.key]:t.CLOUDFLARE.defaultValue};console.debug("[background] Default values:",n);const c=async function(e,r){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3;for(let a=1;a<=t;a++)try{return await o(e,r),void console.debug(`[background] Successfully set ${e} on attempt ${a}`)}catch(r){if(console.warn(`[background] Failed to set ${e} on attempt ${a}: ${r.message}`),a===t)throw console.error(`[background] Failed to set ${e} after ${t} attempts`),new Error(`Failed to set ${e}: ${r.message}`);await s(500)}};await Promise.all([...Object.entries(n).map((e=>{let[r,t]=e;return c(r,t)})),...Object.entries(a).map((e=>{let[r,t]=e;return c(r,t)})),c("initialized",!0)]),console.debug("[background] Extension initialization completed")}}catch(e){throw console.error("[background] Error initializing extension:",e),e}},i="undefined"!=typeof browser?browser.runtime:chrome.runtime,l="undefined"!=typeof browser?browser.tabs:chrome.tabs;let u,d,g;function p(e,r,t){const a=void 0!==t?{frameId:t}:{};return"undefined"!=typeof browser?browser.tabs.sendMessage(e,r,a):new Promise(((t,o)=>{chrome.tabs.sendMessage(e,r,a,(e=>{const r=chrome.runtime.lastError;if(r)return console.warn("sendMessage error:",r.message),o(r);t(e)}))}))}i.onStartup.addListener((async()=>{console.debug("[background] Extension started"),await c()})),i.onInstalled.addListener((async()=>{console.debug("[background] Extension installed"),await c()})),u=n.CREATE_JOB_URL,d=n.GET_RESULT_URL,g=n.REPORT_URL,i.onMessage.addListener(((e,r,a)=>{switch(console.debug("[background] Received message:",{type:e.type,source:e.source,sender:r.tab?`Tab ${r.tab.id}`:"Unknown",url:r.url}),e.type){case"getURL":return async function(e,r){const t="undefined"!=typeof browser?browser.tabs:chrome.tabs;if(e.tab&&e.tab.id)try{const a=await t.get(e.tab.id);console.debug("[background] Tab URL:",a.url),r(a.url)}catch(e){console.error("[background] Error getting tab URL:",e),r("")}else r("")}(r,a),!0;case"createTask":return async function(e,r){let a=await(async(e,r)=>{const t="undefined"!=typeof browser?browser.storage.local:chrome.storage.local,a="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{const o=await t.get([e]);if(a.lastError)throw new Error(`Error retrieving ${e}: ${a.lastError.message}`);return null!=o[e]?o[e]:r}catch(r){throw console.error(`[storageHelpers] Error retrieving ${e}:`,r),r}})(t.APP_ID.key,t.APP_ID.defaultValue);const o=JSON.parse(e);o.appId=a;try{const e=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);const t=await e.json();0===Number(t.errorId)?(console.debug("[background] Job created:",t.taskId),r(t.taskId)):(console.warn("[background] API returned an error:",t.errorCode,t.errorDescription),r(""))}catch(e){console.error("[background] Error creating task:",e),r("")}}(e.data,a),!0;case"getTaskResult":return async function(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:30,t=arguments.length>2?arguments[2]:void 0;try{const a=Date.now();for(;Date.now()-a<=1e3*r;){await s(350);try{const r=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json"},body:e});if(!r.ok){console.warn(`[background] HTTP error! Status: ${r.status}`);continue}const a=await r.json();if(console.debug("[background] Job result:",a),a.status&&("ready"===a.status||"fail"===a.status))return void t(a)}catch(e){console.error("[background] Error fetching task result:",e),await s(1e3)}}t("")}catch(e){console.error("[background] Error in getTaskResult:",e),t("")}}(e.data.data,e.data.timeWait,a),!0;case"reportTask":return async function(e,r){console.log("Da vao reportTask");try{const t={id:e.taskIds||[],isSuccess:e.result,crxVersion:i.getManifest().version},a=await fetch(g,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!a.ok)throw new Error(`HTTP error! Status: ${a.status}`);const o=await a.json();console.debug("[background] Report sent: "+(e.result?"Success":"Failure"),o),r(o)}catch(e){console.error("[background] Failed to send report:",e),r("")}}(e.data,a),!0;case"createImageBase64":return async function(e,r){try{const t=await fetch(e),a=await t.blob(),o=new FileReader;o.onloadend=()=>{const e=o.result.split(",")[1];r(e)},o.onerror=()=>{console.error("[background] Failed to read blob"),r("")},o.readAsDataURL(a)}catch(e){console.error("[background] Failed to fetch image:",e),r("")}}(e.data.url,a),!0;case"getCanvasBase64_screenshot":return async function(e,r,t){if(!e||!e.id)return void t({error:"Tab không hợp lệ."});const a=e.id;try{const o=await p(a,{type:"getAllRectIframe"});console.log("frames",o);const s=o.find((e=>e.src.includes("frame=challenge")));if(!s)return void t({error:"Không tìm thấy frame hCaptcha."});console.log("hcaptchaFrame ",s);const n=await l.captureVisibleTab(e.windowId,{format:"png"}),c={left:s.rect.left+r.left,top:s.rect.top+r.top,width:r.width,height:r.height},i=await p(a,{type:"cropImage",screenshotDataUrl:n,cropConfig:c},0);if(i.error)return void t({error:i.error});t({base64:i.base64})}catch(e){console.error("[background] Lỗi trong quá trình chụp và cắt ảnh:",e),t({error:`Đã xảy ra lỗi: ${e.message}`})}}(r.tab,e.data.rectCanvas,a),!0;default:return console.error("[background] Unknown request type:",e.type),a(""),!0}}))})();