(()=>{"use strict";const e={API_KEY:{key:"api_key",defaultValue:""},APP_ID:{key:"appId",defaultValue:""},POWER_ON:{key:"power_on",defaultValue:!0},TIKTOK:{key:"tiktok",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},FUNCAPTCHA:{key:"funcaptcha",defaultValue:{delayClick:100,loop:!0,isActive:!0,maxImageCaptcha:25}},ZALO:{key:"zalo",defaultValue:{delayClick:100,loop:!0,isActive:!0}},SHOPEE:{key:"shopee",defaultValue:{delaySwipe:15,loop:!0,isActive:!0}},RECAPTCHAV2:{key:"reCaptchav2",defaultValue:{delayClick:500,loop:!0,isActive:!0,useToken:!1}},AMZN:{key:"amzn",defaultValue:{delayClick:100,loop:!0,isActive:!0}},GEETEST:{key:"geetest",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},SLIDE_ALL:{key:"slide_all",defaultValue:{delaySwipe:15,loop:!0,isActive:!0}},HCAPTCHA:{key:"hcaptcha",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},CLOUDFLARE:{key:"cloudflare",defaultValue:{delayClick:2e3,isActive:!0}}};async function t(e,t,o){const n="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{return await new Promise(((a,r)=>{n.sendMessage({source:e,type:t,data:o},(e=>{n.lastError?r(new Error(`Error sending message: ${n.lastError.message}`)):a(e)}))}))}catch(e){throw console.error(`[messageHelpers] Error in sending message: ${e.message}`),e}}const o=async(e,t)=>{const o="undefined"!=typeof browser?browser.storage.local:chrome.storage.local,n="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{const a=await o.get([e]);if(n.lastError)throw new Error(`Error retrieving ${e}: ${n.lastError.message}`);return null!=a[e]?a[e]:t}catch(t){throw console.error(`[storageHelpers] Error retrieving ${e}:`,t),t}};Promise.resolve();async function n(e){return new Promise((t=>setTimeout(t,e)))}function a(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success",o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=document.getElementById("captcha-message");n||(n=document.createElement("div"),n.id="captcha-message",n.style.zIndex="99999999",n.style.padding="3px 3px",n.style.borderRadius="3px",n.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.2)",n.style.fontSize="10px",n.style.fontWeight="600",n.style.fontFamily="Arial, sans-serif",n.style.textAlign="center",n.style.whiteSpace="nowrap",n.style.color="white",n.style.top="1px",o&&o.parentElement?(n.style.position="absolute",n.style.left="2px",o.parentElement.appendChild(n)):(n.style.position="fixed",n.style.left="1px",document.body.appendChild(n)));const a={success:"linear-gradient(90deg, #6a11cb,rgb(191, 37, 252))",error:"linear-gradient(90deg, #ff416c, #ff4b2b)",warning:"linear-gradient(90deg, #ff9a44, #fc6076)",info:"linear-gradient(90deg, #17a2b8, #138496)"};n.innerText="[OMOcaptcha.com] "+e,n.style.background=a[t]||a.success,n.style.display="block"}async function r(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{timeout:5e3,maxRetries:3};try{const{timeout:o,maxRetries:a}=t,r={arkoselabs:"image/jpeg"};function c(e){for(const[t,o]of Object.entries(r))if(e.includes(t))return o;return"image/png"}if(e instanceof HTMLCanvasElement||e.tagName&&"CANVAS"===e.tagName.toUpperCase())try{if(0===e.width||0===e.height)return console.log("Canvas rỗng hoặc không có kích thước"),"";const i=e.getBoundingClientRect(),s=i.width,l=i.height,u=document.createElement("canvas");u.width=s,u.height=l;u.getContext("2d").drawImage(e,0,0,s,l);const d="image/png",h=u.toDataURL(d).split(",")[1];return h||(console.log("Không thể lấy base64 từ canvas"),"")}catch(g){return console.log("Lỗi khi chụp màn hình canvas:",g),""}if(e instanceof Element)try{const f=e.src;if(f&&f.startsWith("data:image/")){const m=f.split(",")[1];return m||(console.log("Base64 rỗng từ src của element"),"")}e=f||""}catch(p){return console.log("Lỗi khi xử lý element:",p),""}if("string"==typeof e&&e.startsWith("blob:")){console.log("Da vao blob");try{return await new Promise((t=>{const o=new Image;o.setAttribute("crossOrigin","anonymous");const n=setTimeout((()=>{t("")}),1e3);o.onload=function(){console.log("Vao trong onload"),clearTimeout(n);try{const o=document.createElement("canvas");o.width=this.naturalWidth,o.height=this.naturalHeight;o.getContext("2d").drawImage(this,0,0);const n=c(e);o.toBlob((e=>{if(!e)return void t("");const o=new FileReader;o.onloadend=()=>{const e=o.result.split(",")[1];t(e)},o.onerror=()=>t(""),o.readAsDataURL(e)}),n)}catch(e){console.log("Lỗi khi xử lý blob URL:",e),t("")}},o.onerror=()=>{clearTimeout(n),t("")},o.src=e,console.log("This is img:"),console.log("img src:",o.src)}))}catch(y){return console.log("Lỗi khi xử lý blob URL:",y),""}}if("string"==typeof e){console.log("Vao den input string:");try{for(let b=0;b<a;b++)try{const w=new AbortController,v=setTimeout((()=>w.abort()),o),k=await fetch(e,{signal:w.signal});if(clearTimeout(v),!k.ok)throw new Error(`HTTP error ${k.status}`);const C=await k.blob();return await new Promise(((e,t)=>{const o=new FileReader;o.onloadend=()=>e(o.result.split(",")[1]),o.onerror=()=>t(new Error("Failed to read blob as base64")),o.readAsDataURL(C)}))}catch(A){if(b===a-1)return console.log("Hết lượt thử fetch:",A),"";await n(500)}}catch(E){return console.log("Lỗi khi fetch URL:",E),""}}return console.log("Đầu vào không được hỗ trợ:",e),""}catch(x){return console.log("Lỗi chung trong fetchImageToBase64:",x),""}}function c(e){["pointerdown","mousedown","mouseup","click"].forEach((function(t){e.dispatchEvent(new MouseEvent(t,{bubbles:!0,cancelable:!0,view:window}))}))}let i,s,l,u,d,h;async function g(){i=await o(e.POWER_ON.key,e.POWER_ON.defaultValue),s=await o(e.API_KEY.key,e.API_KEY.defaultValue);const t=await o(e.FUNCAPTCHA.key,e.FUNCAPTCHA.defaultValue);l=t.delayClick,u=t.loop,d=t.isActive,h=t.maxImageCaptcha}let f=!1,m=[];console.log("This is Funcaptcha");async function p(){console.log("Đã vào captchaClickImage1"),a("captchaClickImage1","green");let e=E(".challenge-instructions-container");if(!e)return;const t=()=>{c(document.querySelector('[class*="restart-button"]'))};e=e.trim(),l<1e3&&(l=1e3);let o="";for(let c=0;c<500;c++){if(c>0){if(await n(l),C(['div[class*="tile-game-fail box screen"]','div[class*="match-game-fail box screen"]']))return u&&(a("Restart button...","red"),t()),a("Failed to solve captcha","red"),void console.log("Giải captcha thất bại");if(C(['div[class*="error box screen"]']))return u&&document.querySelector('div[class*="error box screen"] button').click(),a("Failed to solve captcha","red"),void console.log("Giải captcha thất bại");if(C(['div[class*="victory box screen"]']))return console.log("Giải captcha thành công"),void a("Successfully solved captcha","green")}const i=await w(o);if(!i)continue;o=i;const s=await r(o);if(!s)return console.error("Failed to fetch image base64 for URL:",o),a("Failed to fetch image base64 for URL","red"),void(u&&t());const d=await v(s,e,30);if(null===d)return void(u&&(a("Restart button...","red"),t()));if("Server 500"===d.result){o="";continue}const h=d.result.index;document.querySelector('button[aria-label*="Image '+h+'"]').click()}}async function y(){console.log("Đã vào captchaClickImage2"),a("captchaClickImage2","green");let e=E("#game_children_text");if(e){e=e.trim(),e.endsWith(".")&&(e=e.slice(0,-1)),l<1e3&&(l=1e3);for(let t=0;t<500;t++){if(t>0){await n(l);const e=await k(['div[class*="error box screen"] button',"#wrong_children_button"],1);if(e)return u&&e.click(),console.log("Giải captcha thất bại"),void a("Failed to solve captcha","red");if(A('[id="victoryScreen"]'))return console.log("Giải captcha thành công"),void a("Successfully solved captcha","green")}const o=document.querySelector("#game_challengeItem_image");if(!o)continue;const c=await r(o,{timeout:5e3,maxRetries:3});if(!c)return a("No imageBase64","green"),void(u&&document.querySelector('a[aria-label="Start over with a different challenge" i]').click());const i=await v(c,e,20);if(null===i)return void(u&&document.querySelector('a[aria-label="Start over with a different challenge" i]').click());if("Server 500"===i.result)continue;const s=i.result.index;await k(['[aria-label*="Image '+s+'" i]'],1e3)&&document.querySelector('[aria-label*="Image '+s+'" i]').click()}}}async function b(){console.log("Da vao captchaClickButton"),a("captchaClickButton","green"),console.log("Gia tri MAX_IMAGE_CAPTCHA",h);const e=()=>{c(document.querySelector('[class*="restart-button"]'))};let t=E(".match-game .text");if(!t)return;console.log("Text captcha tren",t);const o=t.match(/\(.*\b(\d+)\)$/);if(o){const e=parseInt(o[1],10);if(console.log("So lon nhat trong dau ngoac:",e),e>h)return void a(`Image > ${h}, stop function`,"red")}t=t.split("(")[0].trim(),console.log("Text captcha giua",t),t.endsWith(".")&&(t=t.slice(0,-1)),console.log("Text captcha cuoi cung",t);let i="";for(let o=0;o<500;o++){if(o>0){if(await n(l),C(['div[class*="tile-game-fail box screen"]','div[class*="match-game-fail box screen"]']))return u&&(a("Restart captcha","red"),e()),console.log("Giải captcha thất bại"),await T(!1),void a("Failed to solve captcha","red");if(C(['div[class*="error box screen"]']))return u&&document.querySelector('div[class*="error box screen"] button').click(),console.log("Giải captcha thất bại"),await T(!1),void a("Failed to solve captcha","red");if(C(['div[class*="victory box screen"]']))return void a("Successfully solved captcha","green")}const s=await w(i);if(!s)continue;i=s;const d=await r(i);if(!d)return a("No imageBase64","red"),console.error("Failed to fetch image base64 for URL:",i),void(u&&e());let h=null;for(let o=0;o<3;o++){const n=await v(d,t,30);if(console.log("taskResult",n),!n&&2===o)return a("No task result","red"),void(u&&e());if(n&&n.result){h=parseInt(n.result.index,10);break}}if(!h)return;if(h-=1,h>30)return u&&e(),console.log("Giải captcha thất bại"),void a("Failed to solve captcha","red");a(`Click next (${h})...`,"red");for(let e=0;e<h;e++)e>0&&await n(l),c(document.querySelector(".right-arrow"));a("Click submit...","red"),x(document.querySelector('div[class*="match-game box screen"] button'))}}async function w(e){const t=document.querySelector("body").innerHTML.match(/blob:https:\/\/(.*?)arkoselabs(.*?)\.com\/[a-zA-Z0-9-]+/);return t?e===t[0]?(await n(500),null):t[0]:(await n(500),null)}async function v(e,o,n){try{a("Creating task...","green");const r=await async function(e,o){const n=JSON.stringify({clientKey:s,task:{type:"FuncaptchaImageTask",imageBase64:e,other:o}});try{const e=await t("FUNCAPTCHA","createTask",n);return e||(console.error("[funcaptcha] No taskId returned from createTask"),a("No taskId returned from createTask","red"),"")}catch(e){return console.error("[funcaptcha] Failed to create task:",e),""}}(e,o);if(!r)return a("No taskId","red"),console.warn("[funcaptcha] Failed to create task"),null;m.push(r);const c=await async function(e,o){const n=JSON.stringify({clientKey:s,taskId:e});try{const e=await t("FUNCAPTCHA","getTaskResult",{data:n,timeWait:o});return e?"fail"===e.status?(console.log("[funcaptcha] API error:",e),a(`API error: ${e}`,"red"),null):e.solution?e.solution:e.index?e:(console.log("[funcaptcha] Invalid API response: missing result or index"),a("Invalid API response: missing result or index","red"),null):(console.log("[funcaptcha] No result returned from getTaskResult"),a("No result returned from getTaskResult","red"),null)}catch(e){return console.log("[funcaptcha] Failed to get task result:",e),a(`Failed to get task result: ${e}`,"red"),null}}(r,n);return c&&"Server 500"!==c?{result:c}:null}catch(e){return console.log("ERROR processCaptchaTask",e),null}}async function k(e,t){const o=Math.ceil(t/1e3);for(let t=0;t<o;t++){await new Promise((e=>setTimeout(e,1e3)));for(const t of e){const e=document.querySelector(t);if(e)return e}}return null}function C(e){for(const t of e){const e=document.querySelector(t);if(e)return e}return null}function A(e){return!!document.querySelector(e)}function E(e){const t=document.querySelector(e);return t?t.textContent.trim():null}function x(e){if(!e)return void console.error("Element không hợp lệ.");if(console.log("Vào hàm simulateHumanMouseMovement"),!function(e){const t=e.getBoundingClientRect();return t.width>0&&t.height>0&&t.bottom>=0&&t.right>=0&&t.top<=(window.innerHeight||document.documentElement.clientHeight)&&t.left<=(window.innerWidth||document.documentElement.clientWidth)}(e))return void console.error("Element không hiển thị hoặc không có kích thước hợp lệ.");console.log("Đã qua isElementVisible");const t=e.getBoundingClientRect(),o=t.left+t.width/2,n=t.top+t.height/2,a=Math.random()*window.innerWidth/2,r=Math.random()*window.innerHeight/2,i=Math.floor(20*Math.random())+10;!function t(c){if(c>=i)return void console.log("Đã kết thúc di chuyển chuột đến element.");const s=(l=c/i,1-Math.pow(1-l,3));var l;const u=a+(o-a)*s,d=r+(n-r)*s,h=5*(Math.random()-.5),g=5*(Math.random()-.5),f=new MouseEvent("mousemove",{bubbles:!0,clientX:u+h,clientY:d+g});if(document.dispatchEvent(f),0===c){const t=new MouseEvent("mouseover",{bubbles:!0,clientX:u+h,clientY:d+g});e.dispatchEvent(t)}const m=30*Math.random()+20;setTimeout((()=>t(c+1)),m)}(0),c(e)}async function T(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(console.log("Đang check resolvedTaskIds",m),0===m.length)return;const o={taskIds:m,result:e};try{await t("FUNCAPTCHA","reportTask",o)}catch(e){console.error("Failed to send report:",e)}finally{m=[]}}new class{constructor(e,t){this.selectors=e,this.callback=t,this.processedNodes=new Set,this.observer=new MutationObserver(this.handleMutation.bind(this)),this.startObserving()}startObserving(){this.observer.observe(document.body,{childList:!0,subtree:!0})}stopObserving(){this.observer.disconnect()}async handleMutation(e){if(i&&d)for(const t of e){const e=Array.from(t.addedNodes);for(const t of e)if(t.nodeType===Node.ELEMENT_NODE)for(const e of this.selectors)if(t.matches(e)&&!this.processedNodes.has(t))this.processedNodes.add(t),await this.callback(e,[t]);else{const o=Array.from(t.querySelectorAll(e));for(const t of o)this.processedNodes.has(t)||(this.processedNodes.add(t),await this.callback(e,o))}}}}(['button[aria-describedby="descriptionVerify"]','p[aria-label*="Working, please wait" i]','button[data-theme="home.verifyButton"]',".error .button","#wrongTimeout_children_button",'button[id="home_children_button"]'],(async(e,t)=>{if(await g(),!f&&i&&d&&s&&"YOUR_CLIEN_KEY"!==s){console.log("Vào đến DOMObserver");try{f=!0,await n(1e3);const e=await k(['div[class*="error box screen"] button',"#wrong_children_button"],1e3);if(e)return u&&e.click(),void console.log("Giải captcha thất bại");for(let e=0;e<10;e++){const e=await k(['button[data-theme="home.verifyButton"]','button[id="home_children_button"]','button[aria-describedby="descriptionVerify"]'],1e3);if(e?(console.log("[funcaptcha] Click verifyButton"),c(e),m=[]):console.log("[funcaptcha] không tìm thấy verifyButton"),A(".challenge-instructions-container"))await p();else if(A(".match-game .text"))await b();else{if(!A("#game_children_text")){console.log("[funcaptcha] Không tìm thấy captcha");continue}await y()}console.log("[funcaptcha] chay xong findElement");break}}catch(e){console.error("Đã bị lỗi",e)}finally{f=!1}}})),(async()=>{await g()})()})();