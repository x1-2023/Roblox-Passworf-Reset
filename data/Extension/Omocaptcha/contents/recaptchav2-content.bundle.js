(()=>{"use strict";const e={API_KEY:{key:"api_key",defaultValue:""},APP_ID:{key:"appId",defaultValue:""},POWER_ON:{key:"power_on",defaultValue:!0},TIKTOK:{key:"tiktok",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},FUNCAPTCHA:{key:"funcaptcha",defaultValue:{delayClick:100,loop:!0,isActive:!0,maxImageCaptcha:25}},ZALO:{key:"zalo",defaultValue:{delayClick:100,loop:!0,isActive:!0}},SHOPEE:{key:"shopee",defaultValue:{delaySwipe:15,loop:!0,isActive:!0}},RECAPTCHAV2:{key:"reCaptchav2",defaultValue:{delayClick:500,loop:!0,isActive:!0,useToken:!1}},AMZN:{key:"amzn",defaultValue:{delayClick:100,loop:!0,isActive:!0}},GEETEST:{key:"geetest",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},SLIDE_ALL:{key:"slide_all",defaultValue:{delaySwipe:15,loop:!0,isActive:!0}},HCAPTCHA:{key:"hcaptcha",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},CLOUDFLARE:{key:"cloudflare",defaultValue:{delayClick:2e3,isActive:!0}}};async function t(e,t,r){const a="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{return await new Promise(((o,s)=>{a.sendMessage({source:e,type:t,data:r},(e=>{a.lastError?s(new Error(`Error sending message: ${a.lastError.message}`)):o(e)}))}))}catch(e){throw console.error(`[messageHelpers] Error in sending message: ${e.message}`),e}}const r=async(e,t)=>{const r="undefined"!=typeof browser?browser.storage.local:chrome.storage.local,a="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{const o=await r.get([e]);if(a.lastError)throw new Error(`Error retrieving ${e}: ${a.lastError.message}`);return null!=o[e]?o[e]:t}catch(t){throw console.error(`[storageHelpers] Error retrieving ${e}:`,t),t}};Promise.resolve();async function a(e){return new Promise((t=>setTimeout(t,e)))}function o(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=document.getElementById("captcha-message");a||(a=document.createElement("div"),a.id="captcha-message",a.style.zIndex="99999999",a.style.padding="3px 3px",a.style.borderRadius="3px",a.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.2)",a.style.fontSize="10px",a.style.fontWeight="600",a.style.fontFamily="Arial, sans-serif",a.style.textAlign="center",a.style.whiteSpace="nowrap",a.style.color="white",a.style.top="1px",r&&r.parentElement?(a.style.position="absolute",a.style.left="2px",r.parentElement.appendChild(a)):(a.style.position="fixed",a.style.left="1px",document.body.appendChild(a)));const o={success:"linear-gradient(90deg, #6a11cb,rgb(191, 37, 252))",error:"linear-gradient(90deg, #ff416c, #ff4b2b)",warning:"linear-gradient(90deg, #ff9a44, #fc6076)",info:"linear-gradient(90deg, #17a2b8, #138496)"};a.innerText="[OMOcaptcha.com] "+e,a.style.background=o[t]||o.success,a.style.display="block"}async function s(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{timeout:5e3,maxRetries:3};try{const{timeout:r,maxRetries:o}=t,s={arkoselabs:"image/jpeg"};function n(e){for(const[t,r]of Object.entries(s))if(e.includes(t))return r;return"image/png"}if(e instanceof HTMLCanvasElement||e.tagName&&"CANVAS"===e.tagName.toUpperCase())try{if(0===e.width||0===e.height)return console.log("Canvas rỗng hoặc không có kích thước"),"";const i=e.getBoundingClientRect(),c=i.width,l=i.height,d=document.createElement("canvas");d.width=c,d.height=l;d.getContext("2d").drawImage(e,0,0,c,l);const u="image/png",h=d.toDataURL(u).split(",")[1];return h||(console.log("Không thể lấy base64 từ canvas"),"")}catch(g){return console.log("Lỗi khi chụp màn hình canvas:",g),""}if(e instanceof Element)try{const m=e.src;if(m&&m.startsWith("data:image/")){const f=m.split(",")[1];return f||(console.log("Base64 rỗng từ src của element"),"")}e=m||""}catch(p){return console.log("Lỗi khi xử lý element:",p),""}if("string"==typeof e&&e.startsWith("blob:")){console.log("Da vao blob");try{return await new Promise((t=>{const r=new Image;r.setAttribute("crossOrigin","anonymous");const a=setTimeout((()=>{t("")}),1e3);r.onload=function(){console.log("Vao trong onload"),clearTimeout(a);try{const r=document.createElement("canvas");r.width=this.naturalWidth,r.height=this.naturalHeight;r.getContext("2d").drawImage(this,0,0);const a=n(e);r.toBlob((e=>{if(!e)return void t("");const r=new FileReader;r.onloadend=()=>{const e=r.result.split(",")[1];t(e)},r.onerror=()=>t(""),r.readAsDataURL(e)}),a)}catch(e){console.log("Lỗi khi xử lý blob URL:",e),t("")}},r.onerror=()=>{clearTimeout(a),t("")},r.src=e,console.log("This is img:"),console.log("img src:",r.src)}))}catch(y){return console.log("Lỗi khi xử lý blob URL:",y),""}}if("string"==typeof e){console.log("Vao den input string:");try{for(let k=0;k<o;k++)try{const w=new AbortController,b=setTimeout((()=>w.abort()),r),v=await fetch(e,{signal:w.signal});if(clearTimeout(b),!v.ok)throw new Error(`HTTP error ${v.status}`);const T=await v.blob();return await new Promise(((e,t)=>{const r=new FileReader;r.onloadend=()=>e(r.result.split(",")[1]),r.onerror=()=>t(new Error("Failed to read blob as base64")),r.readAsDataURL(T)}))}catch(C){if(k===o-1)return console.log("Hết lượt thử fetch:",C),"";await a(500)}}catch(E){return console.log("Lỗi khi fetch URL:",E),""}}return console.log("Đầu vào không được hỗ trợ:",e),""}catch(A){return console.log("Lỗi chung trong fetchImageToBase64:",A),""}}let n,i,c,l,d,u,h;async function g(){n=await r(e.POWER_ON.key,e.POWER_ON.defaultValue),i=await r(e.API_KEY.key,e.API_KEY.defaultValue);const t=await r(e.RECAPTCHAV2.key,e.RECAPTCHAV2.defaultValue);c=t.delayClick||500,l=t.loop||!1,d=t.isActive||!1,u=t.times||100,h=t.useToken||!1}console.log("Run file recaptchav2");const m={observer:null,async solve(){if(await g(),n&&d&&i&&"YOUR_CLIEN_KEY"!==i){console.log("[reCaptchav2] anchorSolver Status USE_TOKEN:",h);try{const e=document.querySelector("#recaptcha-anchor");if(!e)return void console.warn("Checkbox not found in Anchor iframe");h||"false"===e.getAttribute("aria-checked")&&(e.click(),window.parent.postMessage({type:"checkboxState",state:!0},"*")),this.observer=new MutationObserver((t=>{t.forEach((t=>{if("attributes"===t.type&&"aria-checked"===t.attributeName){const t="true"===e.getAttribute("aria-checked");window.parent.postMessage({type:"checkboxState",state:t},"*")}}))})),this.observer.observe(e,{attributes:!0,attributeFilter:["aria-checked"]})}catch(e){console.warn("Cannot access window.parent due to cross-origin restrictions:",e)}}}},f={game11Num:0,gameType:null,observer:null,checkboxChecked:!1,isGame33:!1,urlImage:null,reportManager:{resolvedTaskIds:[],addTaskId(e){this.resolvedTaskIds.push(e)},async sendReport(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(console.log("Đang check resolvedTaskIds",this.resolvedTaskIds),0===this.resolvedTaskIds.length)return;const r={taskIds:this.resolvedTaskIds,result:e};try{await t("RECAPTCHAV2","reportTask",r)}catch(e){console.error("Failed to send report:",e)}finally{this.resolvedTaskIds=[]}},resetTaskIds(){this.resolvedTaskIds=[]}},initMessageListener(){window.addEventListener("message",(e=>{switch(e.data.type){case"checkboxState":this.checkboxChecked=e.data.state,this.checkboxChecked&&(this.reportManager.sendReport(!0),!l&&this.observer&&this.observer.disconnect());break;case"siteKeyResponse":this.handleSiteKeyResponse(e.data.siteKey);break;case"parentDataResponse":this.handleSiteKeyResponse({siteKey:e.data.siteKey,websiteURL:e.data.websiteURL});break;case"setTokenResponse":this.handleSetTokenResponse(e.data.success,e.data.error)}}))},siteKeyCallback:null,handleSiteKeyResponse(e){this.siteKeyCallback&&(this.siteKeyCallback(e),this.siteKeyCallback=null)},setTokenCallback:null,handleSetTokenResponse(e,t){this.setTokenCallback&&(this.setTokenCallback(e,t),this.setTokenCallback=null)},async solve(){if(await g(),n&&d&&i&&"YOUR_CLIEN_KEY"!==i)try{if(o("Solving ReCaptcha...","green"),h)return void await this.solveWithToken();let e=!1;this.observer=new MutationObserver((async t=>{for(const r of t){const t=Array.from(r.addedNodes),o=this.detectGameType(t,r.target);if("unknown"!==o)if(this.gameType=o,e=!0,"game33"===o||"game44"===o)await this.gameStart(o);else if("game11"===o){const e=r.target.querySelector(".rc-image-tile-wrapper img");e&&(this.increaseGame11Num(),await this.game11Start(e),this.decreaseGame11Num(),await a(1e3),this.checkForGame11ClickNext())}}})),this.observer.observe(document.body,{attributes:!0,childList:!0,subtree:!0,characterData:!0}),setTimeout((()=>{e||(console.warn("No MutationObserver events detected within 10 seconds, refreshing..."),this.refresh(),e=!1)}),1e4),window.parent.postMessage("ready","*")}catch(e){console.error("Error solving reCAPTCHA:",e),o(`Error solving reCAPTCHA: ${e.message}`,"red"),this.reportManager.resetTaskIds()}},async solveWithToken(){try{p("Solving reCAPTCHA with token...","green");const e=await new Promise((e=>{this.siteKeyCallback=e,window.parent.postMessage({type:"getParentData"},"*"),setTimeout((()=>e(null)),5e3)}));if(!e||!e.siteKey||!e.websiteURL)return console.error("No data-sitekey or websiteURL received"),p("No data-sitekey or websiteURL received","red"),void this.reportManager.resetTaskIds();const t={type:"RecaptchaV2TokenTask",websiteURL:e.websiteURL,websiteKey:e.siteKey};let r=null;for(let e=0;e<3;e++)try{if(p("Creating token task...","green"),r=await this.createTask(t),!r)throw new Error("No taskId returned from API");break}catch(t){if(console.error(`createTask attempt ${e+1} failed:`,t),p(`Task creation failed: ${t.message}`,"red"),2===e)return;await a(1e3)}this.reportManager.addTaskId(r);const o=await this.getTaskResult(r,120);if(!o||!o.gRecaptchaResponse)return console.error("No valid token returned from API"),p("Failed to get token","red"),void this.reportManager.resetTaskIds();const s=await new Promise((e=>{this.setTokenCallback=(t,r)=>e({success:t,error:r}),window.parent.postMessage({type:"setToken",token:o.gRecaptchaResponse},"*"),setTimeout((()=>e({success:!1,error:"No response from parent"})),5e3)}));if(!s.success)return console.error("Failed to set token:",s.error),p(`Failed to set token: ${s.error}`,"red"),void this.reportManager.resetTaskIds();p("Token set successfully","green");const n=document.querySelector("#recaptcha-anchor");if(!n)return void console.warn("Checkbox not found in iframe");"false"===n.getAttribute("aria-checked")&&(n.click(),window.parent.postMessage({type:"checkboxState",state:!0},"*"))}catch(e){console.error("Error solving with token:",e),p(`Error solving with token: ${e.message}`,"red"),this.reportManager.resetTaskIds()}},async gameStart(e){console.log("[recaptcha] This is gameStart");try{if(this.checkboxChecked)return void o("Checkbox enabled, skipping game processing","yellow");"game33"===e&&(this.isGame33=!0),o(`Starting game ${e}`,"green");const t=document.querySelector(".rc-image-tile-wrapper");await this.humanizeMouseMovement(t),await a(100+50*Math.random());let r="";for(let e=0;e<20;e++){await a(500);const e=Array.from(document.querySelectorAll(".rc-image-tile-wrapper img"));if(await Promise.all(e.map((e=>new Promise(((t,r)=>{e.complete?t():(e.onload=t,e.onerror=()=>r(new Error("Image load failed")))}))))),e[8].src&&this.urlImage!==e[8].src){this.urlImage=e[8].src,r=e[8].src;break}}const s=await this.query(r,e);if(!s||!s.objects)throw new Error("Missing objects");const n=Array.from(document.querySelectorAll(".rc-imageselect-tile")),i=s.objects;o("Processing images...","green");const c=()=>Math.floor(101*Math.random())+100;for(let e=0;e<i.length;e++){if(console.log("Gia tri random delay",c()),await a(c()),!n[i[e]])throw new Error(`Tile ${i[e]} not found`);await this.simulateElementClick(n[i[e]])}o("Submitting...","green"),await this.next()}catch(e){console.error("Game error:",e),o(`Game error: ${e.message}`,"red"),this.refresh(),this.reportManager.resetTaskIds()}},async game11Start(e){console.log("[RECAPTCHAV2] This is game11Start");try{if(this.checkboxChecked)return void o("Checkbox enabled, skipping game11 processing","yellow");if(!e?.src)return;e.complete||await new Promise(((t,r)=>{e.onload=t,e.onerror=()=>r(new Error("Image load failed"))}));const t=await this.query(e.src,"game11");if(!t)throw new Error("Invalid API response: no result");if(void 0!==t.hasObject?t.hasObject:t.objects&&t.objects.length>0){this.isGame33=!1;const t=e.closest(".rc-imageselect-tile");if(!t)throw new Error("Tile not found for game11 image");t.click();const r=await this.waitForClickConfirmed(t);if(await a(2e3),!r)throw new Error("Failed to confirm click on game11 tile")}}catch(e){console.error("Game11 error:",e),o(`Game11 error: ${e.message}`,"red"),this.refresh(),this.reportManager.resetTaskIds()}},checkForGame11ClickNext(){if("game11"===this.gameType&&0===this.game11Num){if(0===document.querySelectorAll(".rc-imageselect-tile.rc-image-tile-11:not(.rc-imageselect-dynamic-selected)").length&&(this.gameType="",this.next(),this.isGame33)){const e=document.querySelector(".rc-imageselect-error-dynamic-more");e&&"none"!==e.style.display&&(o("Verification failed, refreshing...","red"),this.refresh(),this.reportManager.resetTaskIds())}}},increaseGame11Num(){this.game11Num+=1},decreaseGame11Num(){this.game11Num=Math.max(0,this.game11Num-1)},resetGame11Num(){this.game11Num=0},refresh(){const e=document.querySelector("#recaptcha-verify-button");if(e&&"Skip"===e.textContent)return void e.click();const t=document.querySelector(".rc-button-reload");t?t.click():console.warn("Reload button not found")},async next(){try{if(this.game11Num>0)return;const e=document.querySelector("#recaptcha-verify-button");if(!e)return console.warn("Verify button not found after waiting"),void this.refresh();for(let t=0;t<3;t++){e.click(),await a(1e3);const t=document.querySelector(".rc-imageselect-error-select-more, .rc-imageselect-error-dynamic-more");if(t&&"none"!==t.style.display)return o("Verification failed, refreshing...","red"),this.refresh(),void this.reportManager.resetTaskIds();if(await this.waitForElement("#rc-imageselect-target",3e3))return;await a(500)}}finally{const e=document.querySelector(".rc-imageselect-error-select-more, .rc-imageselect-error-dynamic-more");e&&"none"!==e.style.display&&this.reportManager.resetTaskIds();const t=document.querySelector(".rc-imageselect-incorrect-response");t&&"none"!==t.style.display&&this.reportManager.sendReport(!1)}},waitForElement:async(e,t)=>new Promise((r=>{const a=document.querySelector(e);if(a)return r(a);const o=new MutationObserver(((t,a)=>{const o=document.querySelector(e);o&&(a.disconnect(),r(o))}));o.observe(document.body,{childList:!0,subtree:!0}),setTimeout((()=>{o.disconnect(),r(null)}),t)})),async waitForClickConfirmed(e){for(let t=0;t<20;t++){if(e.classList.contains("rc-imageselect-dynamic-selected"))return!0;await a(500)}return console.warn("Click not confirmed for element:",e),!1},async humanizeMouseMovement(e){if(!e)return;console.log("[hcaptcha] Simulating human-like mouse movement...");const t=e.getBoundingClientRect(),r=Math.floor(3+3*Math.random());for(let o=0;o<r;o++){const r=t.left+Math.random()*t.width,o=t.top+Math.random()*t.height;e.dispatchEvent(new MouseEvent("mousemove",{bubbles:!0,cancelable:!0,view:window,clientX:r,clientY:o,buttons:0})),await a(100+150*Math.random())}},async simulateElementClick(e){if(!e)return;const t=e.getBoundingClientRect(),r=t.left+t.width*(.3+.4*Math.random()),o=t.top+t.height*(.3+.4*Math.random()),s=["mouseover","mouseenter","pointerover","pointerenter","mousemove","pointermove"];for(const t of s)e.dispatchEvent(new MouseEvent(t,{bubbles:!0,cancelable:!0,view:window,clientX:r,clientY:o})),await a(15+20*Math.random());const n=["pointerdown","mousedown","mouseup","click"];for(const t of n)e.dispatchEvent(new MouseEvent(t,{bubbles:!0,cancelable:!0,view:window,clientX:r,clientY:o})),await a(25+30*Math.random());console.log("[hcaptcha] Simulated a human-like click on an element.")},async query(e,t){if(this.checkboxChecked)return o("Checkbox enabled, skipping task creation","yellow"),null;let r;try{if(r=await s(e,{timeout:5e3,maxRetries:3}),"game11"===t&&r.length<=3e3)throw new Error("Base64 length too short for game11");if(("game33"===t||"game44"===t)&&r.length<=2e4)throw new Error("Base64 length too short for game33/game44")}catch(e){return console.error("Failed to fetch image base64:",e),o("Failed to fetch image","red"),null}let n=null;for(let e=0;e<3;e++){const t=document.querySelector("strong");if(t){n=t.innerText;break}e<2&&await a(1e3)}if(!n)return console.error("No <strong> element found after 3 attempts"),o("No question text found","red"),null;let i=null;for(let e=0;e<3;e++)try{o("Creating task...","green");const e={type:"RecaptchaV2ImageTask",imageBase64:r,question:n};if(i=await this.createTask(e),!i)throw new Error("No taskId returned from API");break}catch(t){if(console.error(`createTask attempt ${e+1} failed:`,t),o(`Task creation failed: ${t.message}`,"red"),2===e)return null;await a(1e3)}if(!i)return this.reportManager.resetTaskIds(),null;try{this.reportManager.addTaskId(i);const e=await this.getTaskResult(i,30);return console.log(e),e?{...e,taskId:i}:(console.error("No result returned from API"),o("Failed to get task result","red"),this.reportManager.resetTaskIds(),null)}catch(e){return console.error("getTaskResult failed:",e),o(`Task result failed: ${e.message}`,"red"),this.reportManager.resetTaskIds(),null}},async createTask(e){const r=JSON.stringify({clientKey:i,task:e});try{const e=await t("RECAPTCHAV2","createTask",r);return e||(console.error("[RECAPTCHAV2] No taskId returned from createTask"),"")}catch(e){throw console.error("[RECAPTCHAV2] Failed to create task:",e),e}},async getTaskResult(e,r){const a=JSON.stringify({clientKey:i,taskId:e});try{const e=await t("RECAPTCHAV2","getTaskResult",{data:a,timeWait:r});return e?e.solution?e.solution:e.type?e:(console.error("[recaptcha] Invalid API response: missing solution"),null):(console.error("[recaptcha] No result returned from getTaskResult"),null)}catch(e){return console.error("[recaptcha] Failed to get task result:",e),null}},detectInitialGameType:e=>e.querySelector(".rc-imageselect-table-33")?"game33":e.querySelector(".rc-image-tile-target")?"game11":e.querySelector(".rc-imageselect-table-44")?"game44":"unknown",detectGameType(e,t){for(const r of e){if(r.classList?.contains("rc-imageselect-table-33")&&"rc-imageselect-target"===t.className)return"game33";if(r.classList?.contains("rc-image-tile-target")&&"rc-imageselect-tile"===t.className)return"game11";if(r.classList?.contains("rc-imageselect-table-44")&&"rc-imageselect-target"===t.className)return"game44"}return"unknown"}};function p(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success";const r={success:"linear-gradient(90deg, #6a11cb, rgb(191, 37, 252))",error:"linear-gradient(90deg, #ff416c, #ff4b2b)",warning:"linear-gradient(90deg, #ff9a44, #fc6076)",info:"linear-gradient(90deg, #17a2b8, #138496)"};let a,o;a="[OMOcaptcha] "+e,o=r[t]||r.success,window.parent.postMessage({type:"displayMessage",message:{text:a,background:o}},"*")}f.initMessageListener(),(async()=>{var e;if(await g(),i&&("string"==typeof(e=i)&&e.length>0)){if(d&&n){const e=window.location.href.match(/\/recaptcha\/(.*?)\/anchor\?/),t=window.location.href.match(/\/recaptcha\/(.*?)\/bframe\?/);e&&!t?await m.solve():t&&await f.solve()}}else o("Invalid or missing API KEY","red")})()})();